#################
# Home Assistant#
#################
- id: homeassistant_theme_switch
  alias: "[HA] Set Home Assistant theme for day and night"
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: sun.sun
      to: above_horizon
    - platform: state
      entity_id: sun.sun
      to: below_horizon
  action:
    - service_template: frontend.set_theme
      data_template:
        name: >
          {% if states.sun.sun.state == "above_horizon" %}
            default
          {% else %}
            midnight
          {% endif %}

- id: homeassistant_delay_automations_on_restart
  alias: "[HA] Delay automations on restart"
  hide_entity: true
  trigger:
    platform: homeassistant
    event: start
  action:
    - service: automation.turn_off
      data:
        entity_id:
          - group.all_automations
    - delay:
        seconds: 60
    - service: automation.turn_on
      data:
        entity_id:
          - group.all_automations

###############
# House #
###############

- id: house_start_cleaning
  alias: "[House] Start Cleaning"
  trigger:
    - entity_id: binary_sensor.someone_home
      for:
        minutes: 10
      from: "on"
      platform: state
      to: "off"
  condition:
    - condition: state
      entity_id: sun.sun
      state: above_horizon
  action:
    - data:
        entity_id: vacuum.xiaomi_vacuum_cleaner
      service: vacuum.start

- id: house_stop_cleaning
  alias: "[House] Stop Cleaning"
  trigger:
    - entity_id: binary_sensor.someone_home
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: template
      value_template: '{{not is_state("vacuum.xiaomi_vacuum_cleaner", "docked")}}'
  action:
    - data:
        entity_id: vacuum.xiaomi_vacuum_cleaner
      service: vacuum.return_to_base

- id: house_alexa_guard_arm
  alias: "[House] Alexa Home Guard - Arm"
  trigger:
    - entity_id: binary_sensor.someone_home
      from: "on"
      platform: state
      to: "off"
  action:
    - data:
        entity_id: alarm_control_panel.alexa_guard_a8bd5
      service: alarm_control_panel.alarm_arm_away

- id: house_alexa_guard_disarm
  alias: "[House] Alexa Home Guard - Disarm"
  trigger:
    - entity_id: binary_sensor.someone_home
      from: "off"
      platform: state
      to: "on"
  action:
    - data:
        entity_id: alarm_control_panel.alexa_guard_a8bd5
      service: alarm_control_panel.alarm_disarm

- id: house_sarah_arrive_home
  alias: "[House] Sarah comes home"
  trigger:
    - entity_id: binary_sensor.presence_sarah
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.presence_bruno
      state: "on"
  action:
    - service: notify.mobile_app_bruno_s_iphone
      data:
        title: Sarah is arriving
        message: Hi Bruno, Sarah will be home in a few minutes.

- id: house_bruno_arrive_home
  alias: "[House] Bruno comes home"
  trigger:
    - entity_id: binary_sensor.presence_bruno
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.presence_sarah
      state: "on"
  action:
    - service: notify.mobile_app_sarah_pimentels_iphone
      data:
        title: Bruno is arriving
        message: Hi Sarah, Bruno will be home in a few minutes.

- id: house_all_leave
  alias: "[House] Leave House"
  trigger:
    - entity_id: binary_sensor.someone_home
      from: "on"
      platform: state
      to: "off"
  action:
    - data:
        entity_id: script.house_nobody_home
      service: script.turn_on

- id: house_sunrise
  alias: "[House] Sunrise"
  trigger:
    - platform: state
      entity_id: sun.sun
      from: below_horizon
      to: above_horizon
  action:
    - data:
        entity_id: group.dnd_other_rooms
      service: input_boolean.turn_off

- id: house_wake_up
  alias: "[House] Wake Up"
  trigger:
    platform: template
    value_template: "{{ now().time().hour == states.input_number.house_alarm_clock_hour.state | int and now().time().minute == states.input_number.house_alarm_clock_minutes.state | int }}"
  condition:
    condition: or
    conditions:
      - condition: and
        conditions:
          - condition: state
            entity_id: binary_sensor.someone_home
            state: "on"
          - condition: state
            entity_id: input_boolean.house_alarm_clock_status
            state: "on"
          - condition: state
            entity_id: input_boolean.house_alarm_clock_weekdays
            state: "on"
          - condition: time
            weekday:
              - mon
              - tue
              - wed
              - thu
              - fri
      - condition: and
        conditions:
          - condition: state
            entity_id: input_boolean.house_alarm_clock_status
            state: "on"
          - condition: state
            entity_id: input_boolean.house_alarm_clock_weekdays
            state: "off"
  action:
    - data:
        entity_id: script.house_wake_up
      service: script.turn_on

- id: house_sunset
  alias: "[House] Sunset"
  trigger:
    - event: sunset
      platform: sun
      offset: -00:45:00
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id:
          - scene.sunset
      service: scene.turn_on
    - data:
        entity_id:
          - media_player.everywhere
          - media_player.emma_s_bedroom_echo_dot
        volume_level: 0.3
      service: media_player.volume_set

- id: house_someone_arrives_from_work
  alias: "[House] Bruno or Sarah come home before night when no one else is home"
  trigger:
    - entity_id: binary_sensor.presence_bruno
      from: "off"
      platform: state
      to: "on"
    - entity_id: binary_sensor.presence_sarah
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "off"
    - condition: time
      before: "20:00"
      after: "16:30"
  action:
    - data:
        entity_id: media_player.living_room_echo_dot
        media_content_id: "welcomehome"
        media_content_type: routine
      service: media_player.play_media
    - data:
        entity_id: media_player.everywhere
        volume_level: 0.3
      service: media_player.volume_set

- id: house_someone_arrives_after_sunset
  alias: "[House] Anyone comes home after Sunset"
  trigger:
    - entity_id: binary_sensor.someone_home
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: sun.sun
      state: below_horizon
  action:
    - data:
        entity_id:
          - scene.sunset
      service: scene.turn_on
    - data:
        entity_id:
          - media_player.everywhere
          - media_player.emma_s_bedroom_echo_dot
        volume_level: 0.3
      service: media_player.volume_set

# - id: building_door_bell_ring
#   alias: "[House] Building Door Bell Ring"
#   trigger:
#     - event_data: {}
#       event_type: nello_bell_ring
#       platform: event
#   condition:
#     - condition: state
#       entity_id: binary_sensor.someone_home
#       state: "on"
#   action:
#     - data:
#         data:
#           type: announce
#         message: Someone is at the door downstairs
#         target: media_player.everywhere
#       service: notify.alexa_media

- id: house_guest_mode_on
  alias: "[House] Turn on Guest Mode"
  trigger:
    - entity_id: lock.home_door
      from: "locked"
      platform: state
      to: "unlocked"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_someone
      service: input_boolean.turn_on

- id: house_guest_mode_off
  alias: "[House] Turn off Guest Mode"
  trigger:
    - entity_id: group.all_occupancy_sensors
      for:
        minutes: 10
      from: "on"
      platform: "state"
      to: "off"
  action:
    - data:
        entity_id: input_boolean.presence_someone
      service: input_boolean.turn_off

###############
# Living Room #
###############

- id: living_room_watch_tv_lights_on
  alias: "[Living Room] Watch TV Lights On"
  trigger:
    - entity_id: sensor.watch_netflix
      from: "False"
      platform: state
      to: "True"
    - entity_id: sensor.watch_tv
      from: "False"
      platform: state
      to: "True"
  condition:
    - above: 20
      condition: numeric_state
      entity_id: light.living_room
      value_template: "{{states.light.living_room.attributes.brightness}}"
  action:
    - data:
        entity_id: light.living_room
        kelvin: "{{ state_attr('sensor.circadian_values', 'colortemp') | int }}"
        brightness_pct: "{{ state_attr('switch.circadian_lighting_living_room', 'brightness') | int }}"
        transition: 3
      service: light.turn_on

- id: living_room_watch_tv_lights_off_daytime
  alias: "[Living Room] Watch TV Lights Off (Daytime)"
  trigger:
    - entity_id: sensor.watch_netflix
      from: "True"
      platform: state
      to: "False"
    - entity_id: sensor.watch_tv
      from: "True"
      platform: state
      to: "False"
  condition:
    condition: state
    entity_id: sun.sun
    state: above_horizon
  action:
    - data:
        entity_id: light.living_room
        transition: 5
      service: light.turn_off

- id: living_room_watch_tv_lights_off_nighttime
  alias: "[Living Room] Watch TV Lights Off (Nighttime)"
  trigger:
    - entity_id: sensor.watch_netflix
      from: "True"
      platform: state
      to: "False"
    - entity_id: sensor.watch_tv
      from: "True"
      platform: state
      to: "False"
  condition:
    condition: state
    entity_id: sun.sun
    state: below_horizon
  action:
    - data:
        entity_id: light.living_room
        kelvin: "{{ state_attr('sensor.circadian_values', 'colortemp') | int }}"
        brightness_pct: "{{ state_attr('switch.circadian_lighting_living_room', 'brightness') | int }}"
        transition: 3
      service: light.turn_on

- id: living_room_watch_tv_fan_on
  alias: "[Living Room] Watch TV Fan On"
  trigger:
    - entity_id: sensor.watch_netflix
      from: "False"
      platform: state
      to: "True"
    - entity_id: sensor.watch_tv
      from: "False"
      platform: state
      to: "True"
  condition:
    - above: 25
      condition: numeric_state
      entity_id: sensor.living_room_sensor_temperature
      value_template: "{{states.sensor.living_room_sensor_temperature.state}}"
  action:
    - data:
        command: PowerToggle
        device: "64739991"
        entity_id: remote.harmony_hub
      service: remote.send_command
    - data:
        entity_id: input_boolean.living_room_watch_tv_fan_automation
      service: input_boolean.turn_on

- id: living_room_watch_tv_fan_off
  alias: "[Living Room] Watch TV Fan Off"
  trigger:
    - entity_id: sensor.watch_netflix
      from: "True"
      platform: state
      to: "False"
    - entity_id: sensor.watch_tv
      from: "True"
      platform: state
      to: "False"
  condition:
    - condition: state
      entity_id: input_boolean.living_room_watch_tv_fan_automation
      state: "on"
  action:
    - data:
        command: PowerToggle
        device: "64739991"
        entity_id: remote.harmony_hub
      service: remote.send_command
    - data:
        entity_id: input_boolean.living_room_watch_tv_fan_automation
      service: input_boolean.turn_off

- id: living_room_watch_tv_dnd_on
  alias: "[Living Room] Watch TV DnD On"
  trigger:
    - entity_id: sensor.watch_netflix
      from: "False"
      platform: state
      to: "True"
    - entity_id: sensor.watch_tv
      from: "False"
      platform: state
      to: "True"
  action:
    - data:
        entity_id: input_boolean.dnd_living_room
      service: input_boolean.turn_on

- id: living_room_watch_tv_dnd_off
  alias: "[Living Room] Watch TV DnD Off"
  trigger:
    - entity_id: sensor.watch_netflix
      from: "True"
      platform: state
      to: "False"
    - entity_id: sensor.watch_tv
      from: "True"
      platform: state
      to: "False"
  action:
    - data:
        entity_id: input_boolean.dnd_living_room
      service: input_boolean.turn_off

- id: living_room_lights_on
  alias: "[Living Room] Lights On"
  trigger:
    - entity_id: binary_sensor.presence_living_room
      from: "off"
      platform: state
      to: "on"
    - entity_id: sensor.living_room_sensor_light_level
      platform: state
  condition:
    - condition: state
      entity_id: binary_sensor.presence_living_room
      state: "on"
    - condition: state
      entity_id: input_boolean.dnd_living_room
      state: "off"
    - below: 20
      condition: numeric_state
      entity_id: sensor.living_room_sensor_light_level
  action:
    - data_template:
        entity_id: light.living_room
        kelvin: "{{ state_attr('sensor.circadian_values', 'colortemp') | int }}"
        brightness_pct: "{{ state_attr('switch.circadian_lighting_living_room', 'brightness') | int }}"
        transition: 3
      service: light.turn_on

- id: living_room_lights_off
  alias: "[Living Room] Lights Off"
  trigger:
    - entity_id: binary_sensor.presence_living_room
      from: "on"
      platform: state
      to: "off"
  action:
    - data:
        entity_id: light.living_room
        transition: 5
      service: light.turn_off

- id: living_room_presence_on_tv
  alias: "[Living Room] Presence On (TV)"
  trigger:
    - entity_id: sensor.tv_activity
      from: "False"
      platform: state
      to: "True"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_living_room
      service: input_boolean.turn_on

- id: living_room_presence_off_tv
  alias: "[Living Room] Presence Off (TV)"
  trigger:
    - entity_id: sensor.tv_activity
      from: "True"
      platform: state
      to: "False"
  action:
    - delay:
        minutes: 5
    - data:
        entity_id: input_boolean.presence_living_room
      service: input_boolean.turn_off

- id: living_room_presence_on
  alias: "[Living Room] Presence On (Motion)"
  trigger:
    - entity_id: binary_sensor.hk_living_room_sensor_motion
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_living_room
      service: input_boolean.turn_on

- id: living_room_presence_off
  alias: "[Living Room] Presence Off"
  trigger:
    - entity_id: binary_sensor.hk_living_room_sensor_motion
      from: "on"
      platform: state
      to: "off"
      for:
        minutes: 3
  condition:
    - condition: state
      entity_id: sensor.tv_activity
      state: "off"
    - condition: state
      entity_id: input_boolean.dnd_dining_room
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_living_room
      service: input_boolean.turn_off

- id: living_room_presence_on_lights
  alias: "[Living Room] Presence On (Lights)"
  trigger:
    - entity_id: light.living_room
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_living_room
      state: "off"
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_living_room
      service: input_boolean.turn_on

- id: living_room_presence_off_lights
  alias: "[Living Room] Presence Off (Lights)"
  trigger:
    - entity_id: light.living_room
      from: "on"
      platform: state
      to: "off"
  condition:
    - condition: state
      entity_id: sensor.tv_activity
      state: "off"
    - condition: state
      entity_id: input_boolean.dnd_living_room
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_living_room
      service: input_boolean.turn_off

###############
# Dining Room #
###############

- id: dining_room_lights_on
  alias: "[Dining Room] Lights On"
  trigger:
    - entity_id: binary_sensor.presence_dining_room
      from: "off"
      platform: state
      to: "on"
    - entity_id: sensor.dining_room_sensor_light_level
      platform: state
  condition:
    - condition: state
      entity_id: binary_sensor.presence_dining_room
      state: "on"
    - condition: state
      entity_id: input_boolean.dnd_dining_room
      state: "off"
    - below: 20
      condition: numeric_state
      entity_id: sensor.dining_room_sensor_light_level
  action:
    - data_template:
        entity_id: light.dining_room
        kelvin: "{{ state_attr('sensor.circadian_values', 'colortemp') | int }}"
        brightness_pct: "{{ state_attr('switch.circadian_lighting_dining_room', 'brightness') | int }}"
        transition: 3
      service: light.turn_on

- id: dining_room_lights_off
  alias: "[Dining Room] Lights Off"
  trigger:
    - entity_id: binary_sensor.presence_dining_room
      from: "on"
      platform: state
      to: "off"
  action:
    - data:
        entity_id: light.dining_room
        transition: 5
      service: light.turn_off

- id: dining_room_presence_on
  alias: "[Dining Room] Presence On (Motion)"
  trigger:
    - entity_id: binary_sensor.hk_dining_room_sensor_motion
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_dining_room
      service: input_boolean.turn_on

- id: dining_room_presence_off
  alias: "[Dining Room] Presence Off"
  trigger:
    - entity_id: binary_sensor.hk_dining_room_sensor_motion
      from: "on"
      platform: state
      to: "off"
      for:
        minutes: 3
  condition:
    - condition: state
      entity_id: input_boolean.dnd_dining_room
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_dining_room
      service: input_boolean.turn_off

- id: dining_room_presence_on_lights
  alias: "[Dining Room] Presence On (Lights)"
  trigger:
    - entity_id: light.dining_room
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_dining_room
      state: "off"
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_dining_room
      service: input_boolean.turn_on

- id: dining_room_presence_off_lights
  alias: "[Dining Room] Presence Off (Lights)"
  trigger:
    - entity_id: light.dining_room
      from: "on"
      platform: state
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_dining_room
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_dining_room
      service: input_boolean.turn_off

##################
# Master Bedroom #
##################

- id: master_bedroom_lights_on
  alias: "[Master Bedroom] Lights On"
  trigger:
    - entity_id: binary_sensor.presence_master_bedroom
      from: "off"
      platform: state
      to: "on"
    - entity_id: sensor.master_bedroom_sensor_light_level
      platform: state
  condition:
    - condition: state
      entity_id: binary_sensor.presence_master_bedroom
      state: "on"
    - condition: state
      entity_id: input_boolean.dnd_master_bedroom
      state: "off"
    - below: 20
      condition: numeric_state
      entity_id: sensor.master_bedroom_sensor_light_level
  action:
    - data_template:
        kelvin: "{{ state_attr('sensor.circadian_values', 'colortemp') | int }}"
        brightness_pct: "{{ state_attr('switch.circadian_lighting_master_bedroom', 'brightness') | int }}"
        entity_id: light.master_bedroom
        transition: 3
      service: light.turn_on

- id: master_bedroom_lights_off
  alias: "[Master Bedroom] Lights Off"
  trigger:
    - entity_id: binary_sensor.presence_master_bedroom
      from: "on"
      platform: state
      to: "off"
  action:
    - data:
        entity_id: light.master_bedroom
        transition: 5
      service: light.turn_off

- id: master_bedroom_motion_toggle_dnd_off
  alias: "[Master Bedroom] Motion Toggle DnD Off"
  trigger:
    - entity_id: light.master_bedroom
      from: "off"
      platform: state
      to: "on"
  action:
    - data:
        entity_id: input_boolean.dnd_master_bedroom
      service: input_boolean.turn_off

- id: master_bedroom_presence_on
  alias: "[Master Bedroom] Presence On"
  trigger:
    - entity_id: binary_sensor.hk_master_bedroom_sensor_motion
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_master_bedroom
      service: input_boolean.turn_on

- id: master_bedroom_presence_off
  alias: "[Master Bedroom] Presence Off"
  trigger:
    - entity_id: binary_sensor.hk_master_bedroom_sensor_motion
      from: "on"
      platform: state
      to: "off"
      for:
        minutes: 3
  condition:
    - condition: state
      entity_id: input_boolean.dnd_master_bedroom
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_master_bedroom
      service: input_boolean.turn_off

- id: master_bedroom_presence_on_lights
  alias: "[Master Bedroom] Presence On (Lights)"
  trigger:
    - entity_id: light.master_bedroom
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_master_bedroom
      state: "off"
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_master_bedroom
      service: input_boolean.turn_on

- id: master_bedroom_presence_off_lights
  alias: "[Master Bedroom] Presence Off (Lights)"
  trigger:
    - entity_id: light.master_bedroom
      from: "on"
      platform: state
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_master_bedroom
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_master_bedroom
      service: input_boolean.turn_off

##################
# Emma's Bedroom #
##################

- id: emmas_bedroom_lights_on
  alias: "[Emma's Bedroom] Lights On"
  trigger:
    - entity_id: binary_sensor.presence_emmas_bedroom
      from: "off"
      platform: state
      to: "on"
    - entity_id: sensor.emmas_bedroom_sensor_light_level
      platform: state
  condition:
    - condition: state
      entity_id: binary_sensor.presence_emmas_bedroom
      state: "on"
    - condition: state
      entity_id: input_boolean.dnd_emmas_bedroom
      state: "off"
    - below: 20
      condition: numeric_state
      entity_id: sensor.emmas_bedroom_sensor_light_level
  action:
    - data_template:
        kelvin: "{{ state_attr('sensor.circadian_values', 'colortemp') | int }}"
        brightness_pct: "{{ state_attr('switch.circadian_lighting_emmas_bedroom', 'brightness') | int }}"
        entity_id: light.emmas_bedroom
        transition: 3
      service: light.turn_on

- id: emmas_bedroom_lights_off
  alias: "[Emma's Bedroom] Lights off"
  trigger:
    - entity_id: binary_sensor.presence_emmas_bedroom
      from: "on"
      platform: state
      to: "off"
  action:
    - data:
        entity_id: light.emmas_bedroom
        transition: 5
      service: light.turn_off

- id: emmas_bedroom_motion_toggle_dnd_off
  alias: "[Emma's Bedroom] Motion Toggle DnD Off"
  trigger:
    - entity_id: light.emmas_bedroom
      from: "off"
      platform: state
      to: "on"
  action:
    - data:
        entity_id: input_boolean.dnd_emmas_bedroom
      service: input_boolean.turn_off

- id: emmas_bedroom_presence_on
  alias: "[Emma's Bedroom] Presence On"
  trigger:
    - entity_id: binary_sensor.hk_emmas_bedroom_sensor_motion
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_emmas_bedroom
      service: input_boolean.turn_on

- id: emmas_bedroom_presence_off
  alias: "[Emma's Bedroom] Presence Off"
  trigger:
    - entity_id: binary_sensor.hk_emmas_bedroom_sensor_motion
      from: "on"
      platform: state
      to: "off"
      for:
        minutes: 3
  condition:
    - condition: state
      entity_id: input_boolean.dnd_emmas_bedroom
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_emmas_bedroom
      service: input_boolean.turn_off

- id: emmas_bedroom_presence_on_lights
  alias: "[Emma's Bedroom] Presence On (Lights)"
  trigger:
    - entity_id: light.emmas_bedroom
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_emmas_bedroom
      state: "off"
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_emmas_bedroom
      service: input_boolean.turn_on

- id: emmas_bedroom_presence_off_lights
  alias: "[Emma's Bedroom] Presence Off (Lights)"
  trigger:
    - entity_id: light.emmas_bedroom
      from: "on"
      platform: state
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_emmas_bedroom
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_emmas_bedroom
      service: input_boolean.turn_off

###########
# Kitchen #
###########

- id: kitchen_lights_on
  alias: "[Kitchen] Lights On"
  trigger:
    - entity_id: binary_sensor.presence_kitchen
      from: "off"
      platform: state
      to: "on"
    - entity_id: sensor.kitchen_sensor_light_level
      platform: state
  condition:
    - condition: state
      entity_id: binary_sensor.presence_kitchen
      state: "on"
    - condition: state
      entity_id: input_boolean.dnd_kitchen
      state: "off"
    - below: 20
      condition: numeric_state
      entity_id: sensor.kitchen_sensor_light_level
  action:
    - data_template:
        kelvin: "{{ state_attr('sensor.circadian_values', 'colortemp') | int }}"
        brightness_pct: "{{ state_attr('switch.circadian_lighting_kitchen', 'brightness') | int }}"
        transition: 3
        entity_id: light.kitchen
      service: light.turn_on

- id: kitchen_lights_off
  alias: "[Kitchen] Lights Off"
  trigger:
    - entity_id: binary_sensor.presence_kitchen
      from: "on"
      platform: state
      to: "off"
  action:
    - data:
        entity_id: light.kitchen
        transition: 5
      service: light.turn_off

- id: kitchen_presence_on
  alias: "[Kitchen] Presence On"
  trigger:
    - entity_id: binary_sensor.hk_kitchen_sensor_motion
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_kitchen
      service: input_boolean.turn_on

- id: kitchen_presence_off
  alias: "[Kitchen] Presence Off"
  trigger:
    - entity_id: binary_sensor.hk_kitchen_sensor_motion
      from: "on"
      platform: state
      to: "off"
      for:
        minutes: 3
  condition:
    - condition: state
      entity_id: input_boolean.dnd_kitchen
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_kitchen
      service: input_boolean.turn_off

- id: kitchen_presence_on_lights
  alias: "[Kitchen] Presence On (Lights)"
  trigger:
    - entity_id: light.kitchen
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_kitchen
      state: "off"
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_kitchen
      service: input_boolean.turn_on

- id: kitchen_presence_off_lights
  alias: "[Kitchen] Presence Off (Lights)"
  trigger:
    - entity_id: light.kitchen
      from: "on"
      platform: state
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_kitchen
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_kitchen
      service: input_boolean.turn_off

###########
# Hallway #
###########

- id: hallway_lights_on
  alias: "[Hallway] Lights On"
  trigger:
    - entity_id: binary_sensor.presence_hallway
      from: "off"
      platform: state
      to: "on"
    - entity_id: sensor.hallway_sensor_light_level
      platform: state
  condition:
    - condition: state
      entity_id: binary_sensor.presence_hallway
      state: "on"
    - condition: state
      entity_id: input_boolean.dnd_hallway
      state: "off"
  action:
    - data_template:
        kelvin: "{{ state_attr('sensor.circadian_values', 'colortemp') | int }}"
        brightness_pct: "{{ state_attr('switch.circadian_lighting_hallway', 'brightness') | int }}"
        entity_id: light.hallway
        transition: 3
      service: light.turn_on

- id: hallway_lights_off
  alias: "[Hallway] Lights Off"
  trigger:
    - entity_id: binary_sensor.presence_hallway
      from: "on"
      platform: state
      to: "off"
  action:
    - data:
        entity_id: light.hallway
        transition: 5
      service: light.turn_off

- id: hallway_presence_on
  alias: "[Hallway] Presence On"
  trigger:
    - entity_id: binary_sensor.hallway_combined_sensor_motion
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_hallway
      service: input_boolean.turn_on

- id: hallway_presence_off
  alias: "[Hallway] Presence Off"
  trigger:
    - entity_id: binary_sensor.hallway_combined_sensor_motion
      from: "on"
      platform: state
      to: "off"
      for:
        minutes: 3
  condition:
    - condition: state
      entity_id: input_boolean.dnd_hallway
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_hallway
      service: input_boolean.turn_off

- id: hallway_presence_on_lights
  alias: "[Hallway] Presence On (Lights)"
  trigger:
    - entity_id: light.hallway
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_hallway
      state: "off"
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_hallway
      service: input_boolean.turn_on

- id: hallway_presence_off_lights
  alias: "[Hallway] Presence Off (Lights)"
  trigger:
    - entity_id: light.hallway
      from: "on"
      platform: state
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_hallway
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_hallway
      service: input_boolean.turn_off

############
# Bathroom #
############
- id: bathroom_presence_on
  alias: "[Bathroom] Presence On"
  trigger:
    - entity_id: light.bathroom
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_bathroom
      service: input_boolean.turn_on

- id: bathroom_presence_off
  alias: "[Bathroom] Presence Off"
  trigger:
    - entity_id: light.bathroom
      from: "on"
      platform: state
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_bathroom
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_bathroom
      service: input_boolean.turn_off

###########
# Balcony #
###########
- id: balcony_presence_on
  alias: "[Balcony] Presence On"
  trigger:
    - entity_id: light.balcony_main
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_balcony
      service: input_boolean.turn_on

- id: balcony_presence_off
  alias: "[Balcony] Presence Off"
  trigger:
    - entity_id: light.balcony_main
      from: "on"
      platform: state
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_balcony
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_balcony
      service: input_boolean.turn_off

- id: balcony_lights_on
  alias: "[Balcony] Lights On"
  trigger:
    - entity_id: binary_sensor.presence_balcony
      from: "off"
      platform: state
      to: "on"
  action:
    - data:
        entity_id: switch.balcony_plug
      service: switch.turn_on

- id: balcony_lights_off
  alias: "[Balcony] Lights Off"
  trigger:
    - entity_id: binary_sensor.presence_balcony
      from: "on"
      platform: state
      to: "off"
  action:
    - data:
        entity_id: switch.balcony_plug
      service: switch.turn_off

################
# Laundry Room #
################
- id: laundry_room_presence_on
  alias: "[Laundry] Presence On"
  trigger:
    - entity_id: light.laundry_room
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_laundry_room
      service: input_boolean.turn_on

- id: laundry_room_presence_off
  alias: "[Laundry] Presence Off"
  trigger:
    - entity_id: light.laundry_room
      from: "on"
      platform: state
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_laundry_room
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_laundry_room
      service: input_boolean.turn_off

##########
# Closet #
##########
- id: closet_presence_on
  alias: "[Closet] Presence On"
  trigger:
    - entity_id: light.closet
      from: "off"
      platform: state
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - data:
        entity_id: input_boolean.presence_closet
      service: input_boolean.turn_on

- id: closet_presence_off
  alias: "[Closet] Presence Off"
  trigger:
    - entity_id: light.closet
      from: "on"
      platform: state
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.dnd_closet
      state: "off"
  action:
    - data:
        entity_id: input_boolean.presence_closet
      service: input_boolean.turn_off
